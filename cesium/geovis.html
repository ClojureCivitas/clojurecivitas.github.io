<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="joinr">
<meta name="dcterms.date" content="2025-08-13">
<meta name="description" content="Looking at leveraging cesium for geospatial visualization.">

<title>Working with Cesium – Clojure Civitas</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-68d21bd1aa23fdaa920fe1d269933407.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-4bb19fa9e15c342593cf81188a24865b.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-68d21bd1aa23fdaa920fe1d269933407.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5d54f96dbb2a747cf0b02f8707cc9e44.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-cd88e637282679883cc6d66ed968e918.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-5d54f96dbb2a747cf0b02f8707cc9e44.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script data-goatcounter="https://clojurecivitas.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>


<meta property="og:title" content="Working with Cesium – Clojure Civitas">
<meta property="og:description" content="Looking at leveraging cesium for geospatial visualization.">
<meta property="og:image" content="https://clojurecivitas.github.io/cesium/Stadia.jpg">
<meta property="og:site_name" content="Clojure Civitas">
</head>

<body class="nav-fixed fullcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/civitas-icon.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Clojure Civitas</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../civitas/authors.html"> 
<span class="menu-text">Authors</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../civitas/explorer.html"> 
<span class="menu-text">Explorer</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ClojureCivitas/clojurecivitas.github.io"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../posts.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Working with Cesium</h1>
</div>

<div>
  <div class="description">
    Looking at leveraging cesium for geospatial visualization.
  </div>
</div>

<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://github.com/joinr">joinr</a> <a href="mailto:true" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://scicloj.github.io/">
            Scicloj
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<style></style>
<style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style>
<style>.clay-limit-image-width .clay-image {max-width: 100%}
.clay-side-by-side .sourceCode {margin: 0}
.clay-side-by-side {margin: 1em 0}
</style>
<script src="geovis_files/md-default0.js" type="text/javascript"></script>
<script src="geovis_files/md-default1.js" type="text/javascript"></script>
<section id="geospatial-visualization-with-clay-and-cesiumjs" class="level1">
<h1>Geospatial Visualization With Clay and CesiumJS</h1>
<p>This is a short port of a more sophisticated cljs application that leverages CesiumJS for geospatial visualization, animation, and various interactive 3d projections. After seeing other civitas posts, I decided to try to port over a subset of the functionality in a “lightweight” package, combined with some analysis of open data (in this case, fires in Oregon), and then build up an interactive view/animation of the result.</p>
<p>Clay affords a nice platform for doing this, and scittle can be bent to our will to allow fairly sophisticated cljs/js stuff to be used directly (0 install). We will discuss alternate methods of accomplishing this later in a more efficient manner, but as an experimentation with clay and scittle and cesium, it’s not bad!</p>
<div class="sourceClojure">
<div class="sourceCode" id="cb1"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> cesium.geovis</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span> [scicloj.kindly.v4.kind <span class="at">:as</span> kind]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>            [tablecloth.api <span class="at">:as</span> tc]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>            [charred.api <span class="at">:as</span> charred]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>            [clojure.java.io <span class="at">:as</span> jio]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fire-data" class="level1">
<h1>Fire Data</h1>
<p>Our working dataset comes from historical Oregon fire data. The original can be found at https://catalog.data.gov/dataset/odf-fire-occurrence-data-2000-2022 I have taken the liberty of gzipping the original csv to make it easier to host.</p>
<div class="sourceClojure">
<div class="sourceCode" id="cb2"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> flds</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:FireName</span>  <span class="at">:Size</span>_class <span class="at">:EstTotalAcres</span>  <span class="at">:Ign</span>_DateTime</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:ReportDateTime</span> <span class="at">:Discover</span>_DateTime <span class="at">:Control</span>_DateTime <span class="at">:Lat</span>_DD <span class="at">:Long</span>_DD</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">:CauseBy</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceClojure">
<div class="sourceCode" id="cb3"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> fire-data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">-&gt;</span> (tc/dataset <span class="st">"src/cesium/ODF_Fire_Occurrence_Data_2000-2022.csv.gz"</span> {<span class="at">:key-fn</span> <span class="kw">keyword</span>})</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      (tc/select-columns flds)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      (tc/select-rows (<span class="kw">fn</span> [{<span class="at">:keys</span> [Discover_DateTime Control_DateTime]}]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                        (<span class="kw">and</span>  Discover_DateTime Control_DateTime)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceClojure">
<div class="sourceCode" id="cb4"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fire-data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="clay-dataset">
<p>src/cesium/ODF_Fire_Occurrence_Data_2000-2022.csv.gz [23391 10]:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th>:FireName</th>
<th>:Size_class</th>
<th style="text-align: right;">:EstTotalAcres</th>
<th>:Ign_DateTime</th>
<th>:ReportDateTime</th>
<th>:Discover_DateTime</th>
<th>:Control_DateTime</th>
<th style="text-align: right;">:Lat_DD</th>
<th style="text-align: right;">:Long_DD</th>
<th>:CauseBy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bass 497</td>
<td>B</td>
<td style="text-align: right;">3.20</td>
<td>09/02/2015 05:00:00 PM</td>
<td>09/02/2015 05:05:00 PM</td>
<td>09/02/2015 05:00:00 PM</td>
<td>09/02/2015 11:00:00 PM</td>
<td style="text-align: right;">42.13361</td>
<td style="text-align: right;">-122.04083</td>
<td>Other-Public</td>
</tr>
<tr class="even">
<td>Slick Ear #2</td>
<td>B</td>
<td style="text-align: right;">0.75</td>
<td>07/18/2000 07:00:00 PM</td>
<td>07/19/2000 01:20:00 PM</td>
<td>07/19/2000 01:15:00 PM</td>
<td>07/20/2000 12:50:00 AM</td>
<td style="text-align: right;">44.91519</td>
<td style="text-align: right;">-119.28863</td>
<td>Lightning</td>
</tr>
<tr class="odd">
<td>Woodley</td>
<td>C</td>
<td style="text-align: right;">80.00</td>
<td>08/24/2000 05:30:00 AM</td>
<td>08/24/2000 01:07:00 PM</td>
<td>08/24/2000 01:07:00 PM</td>
<td>09/01/2000 09:30:00 PM</td>
<td style="text-align: right;">45.08509</td>
<td style="text-align: right;">-118.33440</td>
<td>Lightning</td>
</tr>
<tr class="even">
<td>QUEENS BRANCH</td>
<td>A</td>
<td style="text-align: right;">0.10</td>
<td>08/10/2001 05:40:00 PM</td>
<td>08/10/2001 05:47:00 PM</td>
<td>08/10/2001 05:45:00 PM</td>
<td>08/10/2001 06:30:00 PM</td>
<td style="text-align: right;">42.53671</td>
<td style="text-align: right;">-123.21215</td>
<td>Motorist</td>
</tr>
<tr class="odd">
<td>Chilcoot</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>08/12/2014 06:15:00 PM</td>
<td>08/13/2014 04:01:00 PM</td>
<td>08/13/2014 04:00:00 PM</td>
<td>08/14/2014 06:30:00 PM</td>
<td style="text-align: right;">43.45583</td>
<td style="text-align: right;">-122.74889</td>
<td>Lightning</td>
</tr>
<tr class="even">
<td>WREN</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>07/06/2002 01:01:00 PM</td>
<td>07/06/2002 01:04:00 PM</td>
<td>07/06/2002 01:02:00 PM</td>
<td>07/06/2002 01:07:00 PM</td>
<td style="text-align: right;">44.58709</td>
<td style="text-align: right;">-123.42779</td>
<td>Motorist</td>
</tr>
<tr class="odd">
<td>Ritner Creek</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>08/22/2003 04:00:00 AM</td>
<td>08/22/2003 05:00:00 AM</td>
<td>08/22/2003 05:00:00 AM</td>
<td>08/22/2003 09:30:00 AM</td>
<td style="text-align: right;">44.74026</td>
<td style="text-align: right;">-123.49811</td>
<td>Lightning</td>
</tr>
<tr class="even">
<td>Big Tamarack</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>08/22/2003 06:00:00 PM</td>
<td>08/23/2003 09:24:00 AM</td>
<td>08/23/2003 09:24:00 AM</td>
<td>08/23/2003 12:40:00 PM</td>
<td style="text-align: right;">45.63942</td>
<td style="text-align: right;">-117.40483</td>
<td>Lightning</td>
</tr>
<tr class="odd">
<td>COIDC 918</td>
<td>A</td>
<td style="text-align: right;">0.00</td>
<td>08/30/2003 02:20:00 PM</td>
<td>08/30/2003 02:37:00 PM</td>
<td>08/30/2003 02:30:00 PM</td>
<td>08/30/2003 02:41:00 PM</td>
<td style="text-align: right;">43.52418</td>
<td style="text-align: right;">-121.95545</td>
<td>Other-Public</td>
</tr>
<tr class="even">
<td>RAYMOND ROAD</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>09/18/2005 03:00:00 PM</td>
<td>09/18/2005 03:20:00 PM</td>
<td>09/18/2005 03:05:00 PM</td>
<td>09/18/2005 04:30:00 PM</td>
<td style="text-align: right;">46.07650</td>
<td style="text-align: right;">-123.70566</td>
<td>Public Utility</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td style="text-align: right;">…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td style="text-align: right;">…</td>
<td style="text-align: right;">…</td>
<td>…</td>
</tr>
<tr class="even">
<td>Tranisent</td>
<td>A</td>
<td style="text-align: right;">0.00</td>
<td>08/01/2021 07:30:00 AM</td>
<td>08/01/2021 07:55:00 AM</td>
<td>08/01/2021 07:45:00 AM</td>
<td>08/01/2021 08:25:00 AM</td>
<td style="text-align: right;">43.38583</td>
<td style="text-align: right;">-121.72947</td>
<td>Other-Public</td>
</tr>
<tr class="odd">
<td>Moon Mountain</td>
<td>A</td>
<td style="text-align: right;">0.03</td>
<td>09/07/2022 08:00:00 AM</td>
<td>09/07/2022 08:30:00 AM</td>
<td>09/07/2022 08:15:00 AM</td>
<td>09/10/2022 10:30:00 AM</td>
<td style="text-align: right;">42.43686</td>
<td style="text-align: right;">-123.28304</td>
<td>Transient</td>
</tr>
<tr class="even">
<td>Riverbanks Rd 5075</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>07/07/2022 06:00:00 PM</td>
<td>07/07/2022 06:14:00 PM</td>
<td>07/07/2022 06:08:00 PM</td>
<td>07/10/2022 06:08:00 PM</td>
<td style="text-align: right;">42.44781</td>
<td style="text-align: right;">-123.49880</td>
<td>Motorist</td>
</tr>
<tr class="odd">
<td>Grouse Ridge</td>
<td>A</td>
<td style="text-align: right;">0.10</td>
<td>03/24/2022 08:00:00 PM</td>
<td>03/25/2022 10:27:00 AM</td>
<td>03/25/2022 10:00:00 AM</td>
<td>03/25/2022 01:00:00 PM</td>
<td style="text-align: right;">42.56072</td>
<td style="text-align: right;">-122.46125</td>
<td>Recreationist</td>
</tr>
<tr class="even">
<td>Marmot Rd Pile</td>
<td>B</td>
<td style="text-align: right;">9.00</td>
<td>06/28/2022 12:00:00 PM</td>
<td>06/28/2022 12:05:00 PM</td>
<td>06/28/2022 12:05:00 PM</td>
<td>06/28/2022 06:00:00 PM</td>
<td style="text-align: right;">45.40670</td>
<td style="text-align: right;">-122.15716</td>
<td></td>
</tr>
<tr class="odd">
<td>Bagley Creek</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>07/09/2022 10:00:00 AM</td>
<td>07/09/2022 10:15:00 AM</td>
<td>07/09/2022 10:15:00 AM</td>
<td>07/09/2022 10:45:00 AM</td>
<td style="text-align: right;">42.76889</td>
<td style="text-align: right;">-124.46778</td>
<td>Motorist</td>
</tr>
<tr class="even">
<td>Road 2430</td>
<td>B</td>
<td style="text-align: right;">0.75</td>
<td>06/26/2021 04:00:00 PM</td>
<td>06/26/2021 04:58:00 PM</td>
<td>06/26/2021 04:45:00 PM</td>
<td>06/26/2021 09:58:00 PM</td>
<td style="text-align: right;">43.52875</td>
<td style="text-align: right;">-121.35672</td>
<td>Recreationist</td>
</tr>
<tr class="odd">
<td>Spruce Path</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>09/13/2022 11:20:00 AM</td>
<td>09/13/2022 11:20:00 AM</td>
<td>09/13/2022 11:20:00 AM</td>
<td>09/13/2022 12:14:00 PM</td>
<td style="text-align: right;">43.97600</td>
<td style="text-align: right;">-124.09933</td>
<td>Transient</td>
</tr>
<tr class="even">
<td>Bone Canyon</td>
<td>C</td>
<td style="text-align: right;">67.43</td>
<td>06/13/2021 05:22:00 PM</td>
<td>06/14/2021 12:45:00 PM</td>
<td>06/14/2021 12:45:00 PM</td>
<td>06/17/2021 05:10:00 PM</td>
<td style="text-align: right;">45.01056</td>
<td style="text-align: right;">-119.08639</td>
<td>Lightning</td>
</tr>
<tr class="odd">
<td>Milepost 231</td>
<td>A</td>
<td style="text-align: right;">0.10</td>
<td>08/19/2022 03:09:00 PM</td>
<td>08/19/2022 03:09:00 PM</td>
<td>08/19/2022 03:09:00 PM</td>
<td>08/19/2022 04:41:00 PM</td>
<td style="text-align: right;">45.58639</td>
<td style="text-align: right;">-118.46167</td>
<td>Motorist</td>
</tr>
<tr class="even">
<td>That Way 774</td>
<td>A</td>
<td style="text-align: right;">0.01</td>
<td>08/19/2022 05:00:00 PM</td>
<td>08/19/2022 05:00:00 PM</td>
<td>08/19/2022 05:00:00 PM</td>
<td>08/19/2022 06:07:00 PM</td>
<td style="text-align: right;">44.57139</td>
<td style="text-align: right;">-121.38278</td>
<td>Lightning</td>
</tr>
</tbody>
</table>
</div>
<p>The way we’re going to expose this to sci, for efficiency, is to serialize our fire data as json, then load it via a script tag.</p>
<p>I have processing methods for loading from the local file system and the original application does so and then does ETL from cljs over either csv files, or we compile stuff in cljs as EDN defined in data namespaces.</p>
<p>Since we’re using scittle, I don’t want to break the bank on pushing ETL into the interpreter. Clay allows us to preprocess the data and bake it here for consumption, so we’ll do that.</p>
<p>We can use the ambiently available (and fast) charred to spit our stuff to JSON…</p>
<div class="sourceClojure">
<div class="sourceCode" id="cb5"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> extract-fires </span>[d]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">-&gt;&gt;</span> d</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>       (tech.v3.dataset/mapseq-reader)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">vec</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>       (charred/write-json-str )</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">str</span> <span class="st">"FireData = "</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>       (spit <span class="st">"src/cesium/firedata.js"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We only need this is our firedata isn’t already emitted…</p>
<div class="sourceClojure">
<div class="sourceCode" id="cb6"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">when-not</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    (.exists (jio/file <span class="st">"src/cesium/firedata.js"</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  (extract-fires fire-data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="printedClojure">
<div class="sourceCode" id="cb7"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">nil</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cesium wants date/time in a Julian format, but we have conversion paths for js Date types established. So we’ll leave the start/stop times of our fires as strings and coerce them to Date types directly from cljs. when we read this in on the cljs side, we’ll get json objects for each fire event.</p>
<p>In order to use all our stuff, we’ll need a bunch of dependencies… How can we load them in clay though and have them available for our in-browser cljs environment? Script tags of course!</p>
<p>We can abuse hiccup with script tags and just pull in js files as we would with HTML. As demonstrated elsewhere, we can do the same with cljs files (local to this notebook/the page) if we have scittle as a script.</p>
<p>So our scheme is this: define some hidden hiccup that defines a div that loads all of our dependencies.</p>
<p>Then we can build out the browser portion of our app by leveraging cljs tooling (e.g.&nbsp;reagent) via scittle.</p>
<p>Note: the app portion can be as sophisticated and spread out as we’d like it to be. We can have multiple files (e.g.&nbsp;namespaces) and just load them as script tags, and require them from cljs in scittle as normal.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>^<span class="at">:kindly/hide-code</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>(kind/hiccup</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> [<span class="at">:div</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.js"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.promesa.js"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:crossorigin</span> <span class="va">true</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">:src</span> <span class="st">"https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"</span>}]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:crossorigin</span> <span class="va">true</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">:src</span> <span class="st">"https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"</span>}]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.reagent.js"</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"https://cesium.com/downloads/CesiumJS/releases/1.132/Build/Cesium/Cesium.js"</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:link</span> {<span class="at">:href</span> <span class="st">"https://cesium.com/downloads/CesiumJS/releases/1.132/Build/Cesium/Widgets/widgets.css"</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">:rel</span> <span class="st">"stylesheet"</span> }]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">;;color patch</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"color.js"</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">;;safe stringify for debugging...</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"safestring.js"</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">;;data</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"firedata.js"</span> <span class="co">;;creates FireData var.</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/javascript"</span>}]</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">;;app deps.</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"protocols.cljs"</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"time.cljs"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"util.cljs"</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"czml.cljs"</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"etl.cljs"</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"cesium.cljs"</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:src</span> <span class="st">"widget.cljs"</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">:type</span> <span class="st">"application/x-scittle"</span>}]</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div><script src="https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.js" type="application/javascript"></script><script src="https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.promesa.js" type="application/javascript"></script><script crossorigin="crossorigin" src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script><script crossorigin="crossorigin" src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/scittle@0.7.23/dist/scittle.reagent.js" type="application/javascript"></script><script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js" type="application/javascript"></script><link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet"><script src="color.js" type="application/javascript"></script><script src="safestring.js" type="application/javascript"></script><script src="firedata.js" type="application/javascript"></script><script src="protocols.cljs" type="application/x-scittle"></script><script src="time.cljs" type="application/x-scittle"></script><script src="util.cljs" type="application/x-scittle"></script><script src="czml.cljs" type="application/x-scittle"></script><script src="etl.cljs" type="application/x-scittle"></script><script src="cesium.cljs" type="application/x-scittle"></script><script src="widget.cljs" type="application/x-scittle"></script></div>
<p>Our CesiumJS app’s entry point is another hiccup div exposing an app id with the “core.cljs” script being loaded from scittle</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>^<span class="at">:kindly/hide-code</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>(kind/hiccup</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a> [<span class="at">:div#</span>app</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  [<span class="at">:script</span> {<span class="at">:type</span> <span class="st">"application/x-scittle"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">:src</span> <span class="st">"core.cljs"</span>}]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="the-app" class="level1">
<h1>The App</h1>
<p>The application is a typical CesiumJS widget with some reagent ui bits. We have the primary geospatial view, which default to an interactive globe with the ability to spin, zoom, pan, and tilt the view with the mouse or a touchscreen.</p>
<p>Cesium is meant to show animated 3d visuals on top of geospatial layers and projections, so it prominently features a timeline on the bottom. This is an interactive ui that allows the user to move forward and backward into arbitrary points in time, with any temporal data in the visual updating accordingly.</p>
<p>Additionally, the timeline has a control mechanism in the bottom left clock, which allows time to progress forward or backward at a constant rate, to change the rate of change, or to pause the passage of time.</p>
<div id="app"><script src="core.cljs" type="application/x-scittle"></script></div>
<p>As a bonus, I tossed in a few buttons below the main view to simplify the interface. We can load all 23K of our fire data (spanning 2000-2022), if we click “Load Fires!”.</p>
<p>After a second or two the fire events will be loaded and we’ll notice the timeline has changed with a new start time somewhere in the year 2000.</p>
</section>
<section id="a-note-on-map-tiles-and-base-layers" class="level1">
<h1>A Note on Map Tiles and Base Layers</h1>
<p>Cesium is built to work with all sorts of geospatial layers, which are the visual projections of the geography that we want see rendered. We build maps by adding layers (from various sources) and then we can place interactive 3d geometry in the context of these layers.</p>
<p>Most layers come in the form of “map tiles”, which are 3d coordinates mapping a visible chunk of the earth at a particular altitude. So when we zoom into a particular view of the current projection of the earth, the visible tiles are loaded on the fly. This means we either need a tile server or our own local tiles (like a specially oriented directory structure) to serve up typical map layers.</p>
<p>Cesium refers to the underlying layer as the base layer. They provide access to several online map tile providers by way of their “layer picker” interface. This means you can switch the underlyin visual layers at any point if you want to see different features (e.g.&nbsp;topology vs roads vs political boundaries vs 3D terrain…)</p>
<p>Some of the layers Cesium provides appear to be available to you during development time, but if you publish something e.g.&nbsp;on clojure civitas or another domain, you might find that the tile server refuses to send tiles and the visual view is just a default blue tileset (e.g.&nbsp;nothing).</p>
<section id="stadia-tiles-work-in-dev-but-not-production-intended" class="level2">
<h2 class="anchored" data-anchor-id="stadia-tiles-work-in-dev-but-not-production-intended">Stadia Tiles Work In Dev But Not Production (Intended)</h2>
<p>Missing tiles occurs more commonly with the (very nice) series of Stadia tilesets. To add to the confusion, they are explicitly designed to work if you are working on a local development environment, e.g.&nbsp;if you cloned the clojure civitas repository and loaded this example locally instead of going through the clojure civitas github pages site, all of the Stadia tiles will work flawlessly. This is due to the circa 2023 move toward a funded tile hosting service, per https://github.com/CesiumGS/cesium/pull/11485 Since then, Stadia now hosts all the Stamen maptiles, and has terms of service per https://docs.stadiamaps.com/authentication/#authentication . In the case of local development, they allow requests from localhost, but will require an api or an authenticated domain, which requires registering with their service.</p>
<p>At the time of publication, I missed this change, and so we have a change in tileset and presentation to account.</p>
<div><img src="Stadia.jpg"></div>
</section>
</section>
<section id="back-to-the-app" class="level1">
<h1>Back to the App</h1>
<section id="geojson-for-complex-polygonal-layers-state-boundaries" class="level2">
<h2 class="anchored" data-anchor-id="geojson-for-complex-polygonal-layers-state-boundaries">GeoJSON For Complex Polygonal Layers (State Boundaries)</h2>
<p>Since not every layer has state boundaries baked in, I added a layer from open source state boundaries via GeoJSON. We get the added benefit of having states recognized as named entities in Cesium, so clicking on a state boundary will pop up some information about the entity (in this case, the name).</p>
<p>This layer can be toggled using the “Toggle States” button. With some base layers, it may look better to have it toggled off since the current translucent grey polygon fill may collide with interesting visual features.</p>
<section id="side-note---clay-local-files-vs.-quarto" class="level3">
<h3 class="anchored" data-anchor-id="side-note---clay-local-files-vs.-quarto">Side Note - Clay Local Files vs.&nbsp;Quarto</h3>
<p>Normally, we can just reference files that are local to our notebook’s folder, like images and script tags, and Clay will pick them up just fine. When we go to publish on the Quarto web site, Clay will emit a baked document in .qmd format, wherein only the references to assets in use will be picked up and copied over as static assets.</p>
<p>As a consequence of how this Quarto site builds stuff, if we want to have our topojson file available for our CesiumJS app to pull locally, we have to reference it somewhere to indicate it should be copied to the static site (or we stick it in a global resources file etc.).</p>
<p>This work-around applies to any resource we want to have inside a webapp like geojson or other data, since Quarto isn’t going to know that. We can communicate our need by adding some reference to the doc, like a download link using the hiccup below.</p>
<div class="sourceClojure">
<div class="sourceCode" id="cb10"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(kind/hiccup</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> [<span class="at">:a</span> {<span class="at">:href</span> <span class="st">"ne_10m_us_states.topojson"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">:download</span> <span class="st">"ne_10m_us_states.topojson"</span>}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ne_10m_us_states.topojson"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<a download="ne_10m_us_states.topojson" href="ne_10m_us_states.topojson">ne_10m_us_states.topojson</a>
</section>
<section id="geospatial-entities" class="level3">
<h3 class="anchored" data-anchor-id="geospatial-entities">Geospatial Entities</h3>
<p>This is a common idiom in CesiumJS. There is a natural correspondence between geospatial entities and interactive analysis. Cesium enables workflows for interactive selection and viewing; we can tap into these flows with cljs and make even more interesting stuff.</p>
</section>
</section>
<section id="ui" class="level2">
<h2 class="anchored" data-anchor-id="ui">UI</h2>
<p>At this point, we can play around with the UI a bit to see what cesium offers out of the box. Feel free to play with any of the layers in Layer Picker control in the upper right corner.</p>
<p>It might be nice to have some additional information like cities and streets. We can click on the layer picker in upper right, and pick the ‘Bing Aerial Maps With Labels’ layer, or any of the other road maps.</p>
<p>Once that’s done, we’ll zoom in to Oregon in the northwest corner of the US. This is where our data lives, so our fires will show up animating around here as simple arcs popping up from the earth over time, corresponding to the presence of a fire.</p>
<p>If we hit play at this point, we might find a view that looks like this:</p>
<div><img src="firedemo.jpg"></div>
<p>We can pause the view using either the Stop button or the Cesium UI button in the bottom left Clock widget. Since fires are also entities, we can click on one and get some information.</p>
<p>If you are running locally (or in the future, if I pony up for an API key from Stadia) then you can get a view of their Stamen Toner map like this one:</p>
<div><img src="simplefires.jpg"></div>
<p>We change projections with the upper right corner UI control. Clicking on the wireframe globe lets us choose either a 2d planar overhead projection, or a 2.5 Columbus view. Let’s use that.</p>
<p>For reference if we had access to the Stamen Toner layer, this is one more view:</p>
<div><img src="toner.jpg"></div>
</section>
</section>
<section id="d-tiles" class="level1">
<h1>3D Tiles</h1>
<p>One of the biggest features is Cesium’s Ion streaming 3d tile service. We can demo it and turn our flat globe surface into detailed textured terrain.</p>
<div><img src="3daerial.jpg"></div>
<p>The hillshade layer shows off more of the terrain:</p>
<div><img src="3dtiles.jpg"></div>
<p>Stay tuned for more 3d stuff.</p>
</section>
<section id="outro" class="level1">
<h1>Outro</h1>
<p>This is a brief little demonstration of integrating cesium with clay and doing some very basic analysis. In the original application, I had much more sophisticated happenings, like tying together realtime analytics with the visualization (e.g.&nbsp;interactive vega plots).</p>
<p>I have intentionally elided some of the interop requirements for interfacing with cesium and its entity model, geospatial api, timeline, CZML, various uis, etc. The source files in this repo provide some documentation for the intrepid, but I will explore some of these concepts in future posts. CesiumJS has a ton of features, and it’s a bit of a shame the clojure world doesn’t leverage it more.</p>
<div style="background-color:grey;height:2px;width:100%;"></div>
<div><pre><small><small>source: <a href="https://github.com/ClojureCivitas/clojurecivitas.github.io/blob/main/src/cesium/geovis.clj">src/cesium/geovis.clj</a></small></small></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/clojurecivitas\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>